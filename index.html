<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Advanced Submarine Battle Simulator</title>
    <link rel="stylesheet" href="styles.css">
</head>
<body>
    <div id="controls-info">Controls: Arrow keys to move, T to surface, G to dive, SPACE to shoot torpedoes, C to toggle camera mode, +/- to adjust camera distance, L to toggle spotlight, [ and ] to adjust game speed</div>
    
    <div id="dashboard">
        <div class="gauge">
            <div class="gauge-title">DEPTH</div>
            <div class="gauge-value" id="depth-value">0 m</div>
        </div>
        <div class="gauge">
            <div class="gauge-title">SPEED</div>
            <div class="gauge-value" id="speed-value">0 knots</div>
        </div>
        <div class="gauge">
            <div class="compass">
                <div class="compass-needle" id="compass-needle"></div>
                <div class="compass-labels">
                    <div class="compass-label north">N</div>
                    <div class="compass-label east">E</div>
                    <div class="compass-label south">S</div>
                    <div class="compass-label west">W</div>
                </div>
            </div>
            <div class="gauge-title">HEADING</div>
        </div>
        <div class="gauge">
            <div class="gauge-title">ENEMIES</div>
            <div class="gauge-value" id="enemies-value">0</div>
        </div>
        <!-- Radar removed from dashboard and placed in its own container -->
        <div class="gauge" style="display: none;">
            <div class="gauge-title">TIME SCALE</div>
            <div class="gauge-value" id="timescale-value">0.4x</div>
            <div class="timescale-controls">
                <button id="decrease-timescale">-</button>
                <button id="increase-timescale">+</button>
            </div>
        </div>
    </div>
    
    <div id="radar-container">
        <div class="gauge-title">RADAR</div>
        <div id="radar-map" class="radar-map"></div>
    </div>
    
    <!-- Load all scripts in the correct order -->
    <script src="https://cdn.jsdelivr.net/npm/three@0.132.2/build/three.min.js?v=1"></script>
    <script src="playerStats.js?v=1"></script>
    <script src="combatSystem.js?v=1"></script>
    <script src="waveManager.js?v=1"></script>
    <script src="pickupSystem.js?v=1"></script>
    <script src="fishSystem.js?v=1"></script>
    <script src="enemies.js?v=1"></script>
    <script>
        // Add timestamp to prevent caching
        document.write('<script src="game.js?v=' + new Date().getTime() + '"><\/script>');
    </script>
    <!-- Add our start screen -->
    <script src="startScreen.js?v=1"></script>
    <script>
        // Initialize the start screen when the DOM is loaded
        document.addEventListener('DOMContentLoaded', createStartScreen);
    </script>
    
    <!-- Final comprehensive fix for sandy ocean floor -->
    <script>
        // Use a polling approach to wait for the scene to be fully initialized
        (function() {
            console.log("SANDY FLOOR FIX: Script loaded");
            
            // Check every 500ms if the scene is ready
            const checkInterval = setInterval(function() {
                if (window.scene && window.THREE && window.underwaterObjects) {
                    console.log("SANDY FLOOR FIX: Scene and THREE detected, proceeding with fix");
                    clearInterval(checkInterval);
                    
                    // Wait an additional second to ensure everything is fully loaded
                    setTimeout(applySandyFloorFix, 1000);
                }
            }, 500);
            
            // Set a timeout to stop checking after 10 seconds to prevent infinite polling
            setTimeout(function() {
                clearInterval(checkInterval);
                console.log("SANDY FLOOR FIX: Timed out waiting for scene initialization");
            }, 10000);
            
            function applySandyFloorFix() {
                console.log("SANDY FLOOR FIX: Applying fix now");
                
                try {
                    // First, find and remove the existing ocean floor to prevent conflicts
                    let existingFloor = null;
                    window.scene.traverse(function(object) {
                        if (object.isMesh && 
                            object.geometry && 
                            object.geometry.type === 'PlaneGeometry' && 
                            Math.abs(object.position.y - (-25)) < 1) {
                            
                            existingFloor = object;
                            console.log("SANDY FLOOR FIX: Found existing ocean floor", object);
                        }
                    });
                    
                    if (existingFloor) {
                        // Remove it from the scene
                        window.scene.remove(existingFloor);
                        
                        // Also remove from underwaterObjects if present
                        if (window.underwaterObjects && Array.isArray(window.underwaterObjects)) {
                            const index = window.underwaterObjects.indexOf(existingFloor);
                            if (index > -1) {
                                window.underwaterObjects.splice(index, 1);
                            }
                        }
                        console.log("SANDY FLOOR FIX: Removed existing ocean floor");
                    }
                    
                    // Create a new sandy ocean floor
                    createSandyOceanFloor();
                    
                    // Also modify the underwater environment
                    modifyUnderwaterEnvironment();
                    
                    console.log("SANDY FLOOR FIX: Successfully applied all fixes");
                } catch (error) {
                    console.error("SANDY FLOOR FIX: Error applying fix", error);
                }
            }
            
            function createSandyOceanFloor() {
                console.log("SANDY FLOOR FIX: Creating new sandy floor");
                
                // Create a plane geometry for the floor (same size as original)
                const floorGeometry = new THREE.PlaneGeometry(1000, 1000, 50, 50);
                
                // Create a sandy texture using a canvas
                const canvas = document.createElement('canvas');
                const ctx = canvas.getContext('2d');
                canvas.width = 2048; // Higher resolution
                canvas.height = 2048;
                
                // Fill with a very bright sandy base color
                ctx.fillStyle = '#fff8e0'; // Extremely bright sandy color
                ctx.fillRect(0, 0, canvas.width, canvas.height);
                
                // Add sand grain texture with high contrast
                ctx.globalAlpha = 0.8; // Higher alpha for more visibility
                for (let i = 0; i < 300000; i++) { // More particles for denser texture
                    const x = Math.random() * canvas.width;
                    const y = Math.random() * canvas.height;
                    const size = Math.random() * 1.5 + 0.2;
                    const shade = Math.random() * 60;
                    
                    // Bright sandy colors with high contrast
                    ctx.fillStyle = `rgb(${255 - shade}, ${240 - shade}, ${200 - shade})`;
                    ctx.beginPath();
                    ctx.arc(x, y, size, 0, Math.PI * 2);
                    ctx.fill();
                }
                
                // Add some larger sand patterns
                ctx.globalAlpha = 0.5;
                for (let i = 0; i < 500; i++) {
                    const x = Math.random() * canvas.width;
                    const y = Math.random() * canvas.height;
                    const radius = Math.random() * 25 + 5;
                    
                    ctx.strokeStyle = '#e0b070'; // Bright sand color for contrast
                    ctx.lineWidth = 2.5;
                    ctx.beginPath();
                    ctx.arc(x, y, radius, 0, Math.PI * 2);
                    ctx.stroke();
                }
                
                // Reset alpha
                ctx.globalAlpha = 1.0;
                
                // Create texture from canvas
                const sandTexture = new THREE.CanvasTexture(canvas);
                sandTexture.wrapS = THREE.RepeatWrapping;
                sandTexture.wrapT = THREE.RepeatWrapping;
                sandTexture.repeat.set(8, 8);
                
                // Create a material with the sandy texture
                const floorMaterial = new THREE.MeshStandardMaterial({
                    color: 0xfff8e0,          // Extremely bright sand color
                    map: sandTexture,         // Apply our texture
                    roughness: 0.7,
                    metalness: 0.1,
                    emissive: 0xaa7733,       // Add strong glow to make it visible underwater
                    emissiveIntensity: 0.6,   // Very strong glow
                    side: THREE.DoubleSide    // Render both sides to ensure visibility
                });
                
                // Create the floor mesh
                const sandyFloor = new THREE.Mesh(floorGeometry, floorMaterial);
                sandyFloor.rotation.x = -Math.PI / 2;
                sandyFloor.position.y = -25; // Same position as original floor
                
                // CRITICAL: Add to scene
                window.scene.add(sandyFloor);
                console.log("SANDY FLOOR FIX: Added to scene");
                
                // CRITICAL: Add to underwaterObjects array to ensure visibility underwater
                if (window.underwaterObjects && Array.isArray(window.underwaterObjects)) {
                    window.underwaterObjects.push(sandyFloor);
                    console.log("SANDY FLOOR FIX: Added to underwaterObjects array");
                } else {
                    console.error("SANDY FLOOR FIX: underwaterObjects array not found");
                }
                
                // Store reference to sandy floor
                window.sandyOceanFloor = sandyFloor;
                
                return sandyFloor;
            }
            
            function modifyUnderwaterEnvironment() {
                console.log("SANDY FLOOR FIX: Modifying underwater environment");
                
                // Override the updateWaterAppearance function to reduce fog density
                if (window.updateWaterAppearance) {
                    const originalUpdateWaterAppearance = window.updateWaterAppearance;
                    window.updateWaterAppearance = function(cameraY) {
                        // Call original function first
                        originalUpdateWaterAppearance(cameraY);
                        
                        // Then modify underwater settings
                        if (cameraY < window.waterLevel) {
                            // Reduce fog density for better visibility
                            if (window.scene.fog) {
                                window.scene.fog.density = 0.004; // Much less fog
                                window.scene.fog.color.setHex(0x004477); // Slightly different blue
                            }
                            
                            // Increase ambient light for better visibility
                            if (window.ambientLight) {
                                window.ambientLight.intensity = 0.8;
                            }
                            
                            // Make sure our sandy floor is visible
                            if (window.sandyOceanFloor) {
                                window.sandyOceanFloor.visible = true;
                            }
                        }
                    };
                    
                    console.log("SANDY FLOOR FIX: Modified updateWaterAppearance function");
                    
                    // Force an update if we're already underwater
                    if (window.camera && window.camera.position.y < window.waterLevel) {
                        window.updateWaterAppearance(window.camera.position.y);
                    }
                }
            }
        })(); // Self-executing function
        
        // Add keyboard shortcut to regenerate the floor (press 'F' key)
        document.addEventListener('keydown', function(event) {
            if (event.key === 'f' || event.key === 'F') {
                console.log("Manual sandy floor regeneration triggered");
                if (window.scene && window.THREE) {
                    // Remove existing sandy floor if it exists
                    if (window.sandyOceanFloor) {
                        window.scene.remove(window.sandyOceanFloor);
                        
                        // Also remove from underwaterObjects if present
                        if (window.underwaterObjects && Array.isArray(window.underwaterObjects)) {
                            const index = window.underwaterObjects.indexOf(window.sandyOceanFloor);
                            if (index > -1) {
                                window.underwaterObjects.splice(index, 1);
                            }
                        }
                    }
                    
                    // Create a new sandy floor
                    createSandyOceanFloor();
                    
                    // Force an update if we're underwater
                    if (window.camera && window.camera.position.y < window.waterLevel) {
                        window.updateWaterAppearance(window.camera.position.y);
                    }
                }
            }
        });
    </script>
</body>
</html>
